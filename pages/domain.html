<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="keywords" content="i18n, internationalization, translation, javascript, nodejs, js"><title>cqrs - domain</title><link href="../public/css/index.css" rel="stylesheet"><script src="../public/js/jquery-1.7.2.min.js"></script><script src="../public/js/bootstrap-2.0.2.min.js"></script><!-- HTML5 shim, for IE6-8 support of HTML5 elements--><!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]--><!--[if lt IE 8]><link href="../public/css/font-awesome-ie7-2.0.css" rel="stylesheet" type="text/css"><![endif]--></head><body><header class="header"><div class="header-inner"><div class="navbar navbar-fixed-top"><div class="navbar-inner"><div class="container"><!--.btn-navbar is used as the toggle for collapsed navbar content--><a data-toggle="collapse" data-target=".nav-collapse" class="btn btn-navbar"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></a><!-- Be sure to leave the brand out there if you want it shown--><a href="../" class="brand">cqrs</a><!-- Everything you want hidden at 940px or less, place within here--><div class="nav-collapse"><ul class="nav"><li><a href="../index.html">Home</a></li><li><a href="../pages/domain.html">domain</a></li><li><a href="../pages/viewmodel.html">viewmodel</a></li><li><a href="../pages/eventdenormalizer.html">eventdenormalizer</a></li><li><a href="http://jamuhl.github.com/backbone.CQRS/">backbone.CQRS</a></li><li><a href="../cqs/index.html">cqs</a></li></ul></div></div></div></div></div></header><div class="main"><div class="main-inner"><div class="container"><div class="content-container"> <div class="documentation"><div class="row-fluid"><div class="span8"><div class="hero-unit"><h2> 
cqrs-domain</h2><p>cqrs-domain is a node.js module based on nodeEventStore. It can be very useful as domain component if you work with (d)ddd, cqrs, eventdenormalizer, host, etc.</p></div></div><div class="span4 downloads"><p>node.js:</p><pre><code><span class="pln">npm install cqrs</span><span class="pun">-</span><span class="pln">domain</span></code></pre><p>Build status: <a href="http://travis-ci.org/adrai/node-cqrs-domain"><img src="https://secure.travis-ci.org/adrai/node-cqrs-domain.png"></a></p><div style="margin-top: 25px;" class="alert alert-info feature-description"><a href="https://github.com/adrai/node-cqrs-domain"><i class="icon-github"></i> fork me on github</a><br><a href="https://github.com/adrai/node-cqrs-domain/issues"><i class="icon-github"></i> issues</a></div></div></div><div class="row-fluid"><div class="span12"><h2>Initialization</h2><div class="row-fluid"><div class="span4"><h4 class="feature-title">Require</h4></div><div class="span8"><div class="feature"><pre><code><span class="kwd">var</span><span class="pln"> domain </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'cqrs-domain'</span><span class="pun">).</span><span class="pln">domain</span><span class="pun">;</span></code></pre></div></div></div><div class="row-fluid"><div class="span4"><h4 class="feature-title">Register for events</h4></div><div class="span8"><div class="feature"><pre><code><span class="pln">domain</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="str">'event'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">evt</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// send to bus</span><span class="pln"><br /></span><span class="pun">});</span></code></pre><div class="alert alert-info feature-description"><h6>Important hint:</h6><p>The event has these properties: id, event, payload and head(with actual aggregate revision).</p></div></div></div></div><div class="row-fluid"><div class="span4"><h4 class="feature-title">Configure and initialize</h4></div><div class="span8"><div class="feature"><pre><code><span class="pln">domain</span><span class="pun">.</span><span class="pln">initialize</span><span class="pun">({</span><span class="pln"><br />&nbsp; &nbsp; commandHandlersPath</span><span class="pun">:</span><span class="pln"> __dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/commandHandlers'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; aggregatesPath</span><span class="pun">:</span><span class="pln"> __dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/aggregates'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; sagaHandlersPath</span><span class="pun">:</span><span class="pln"> __dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/sagaHandlers'</span><span class="pun">,</span><span class="pln"> &nbsp;</span><span class="com">// optional, only if using sagas</span><span class="pln"><br />&nbsp; &nbsp; sagasPath</span><span class="pun">:</span><span class="pln"> __dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/sagas'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional, only if using sagas</span><span class="pln"><br />&nbsp; &nbsp; handleUndispatchedEvents</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; disableQueuing</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; forcedQueuing</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; commandQueue</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'mongodb'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// example with mongodb</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; dbName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'domain'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; collectionName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'commands'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; host</span><span class="pun">:</span><span class="pln"> </span><span class="str">'localhost'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; port</span><span class="pun">:</span><span class="pln"> </span><span class="lit">27017</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; username</span><span class="pun">:</span><span class="pln"> </span><span class="str">'user'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; password</span><span class="pun">:</span><span class="pln"> </span><span class="str">'pwd'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; timeout</span><span class="pun">:</span><span class="pln"> </span><span class="lit">60</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1000</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; repository</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'mongodb'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// example with mongodb</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; dbName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'domain'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; collectionName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'sagas'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; host</span><span class="pun">:</span><span class="pln"> </span><span class="str">'localhost'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; port</span><span class="pun">:</span><span class="pln"> </span><span class="lit">27017</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; username</span><span class="pun">:</span><span class="pln"> </span><span class="str">'user'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; password</span><span class="pun">:</span><span class="pln"> </span><span class="str">'pwd'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; timeout</span><span class="pun">:</span><span class="pln"> </span><span class="lit">60</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1000</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; eventStore</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'mongodb'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// example with mongodb</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; dbName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'domain'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; eventsCollectionName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'events'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; snapshotsCollectionName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'snapshots'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; host</span><span class="pun">:</span><span class="pln"> </span><span class="str">'localhost'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; port</span><span class="pun">:</span><span class="pln"> </span><span class="lit">27017</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; username</span><span class="pun">:</span><span class="pln"> </span><span class="str">'user'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; password</span><span class="pun">:</span><span class="pln"> </span><span class="str">'pwd'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; timeout</span><span class="pun">:</span><span class="pln"> </span><span class="lit">60</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1000</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; commandLock</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional (used for distributed domain</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// [handling same aggregate instance on multiple machines])</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'mongodb'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// example with mongodb</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; dbName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'domain'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; collectionName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'commandlock'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; host</span><span class="pun">:</span><span class="pln"> </span><span class="str">'localhost'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; port</span><span class="pun">:</span><span class="pln"> </span><span class="lit">27017</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; username</span><span class="pun">:</span><span class="pln"> </span><span class="str">'user'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; password</span><span class="pun">:</span><span class="pln"> </span><span class="str">'pwd'</span><span class="pun">,</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; timeout</span><span class="pun">:</span><span class="pln"> </span><span class="lit">60</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1000</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; &nbsp; retryOnConcurrencyTimeout</span><span class="pun">:</span><span class="pln"> </span><span class="lit">800</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="com">// optional (used for distributed domain</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// [handling same aggregate instance on multiple machines])</span><span class="pln"><br /></span><span class="pun">},</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// ready...</span><span class="pln"><br /></span><span class="pun">});</span></code></pre><div class="alert alert-info feature-description"><h6>Important hint:</h6><p>The validation rules and business rules should be placed parallel to the aggregates folder.</p><p>In this example "__dirname + '/validationRules'" and "__dirname + '/businessRules'"</p><p>The validation rules documentation can be found <a href="https://github.com/adrai/rule-validator">here</a>.</p></div></div></div></div><div class="row-fluid"><div class="span4"><h4 class="feature-title">Handle commands</h4></div><div class="span8"><div class="feature"><pre><code><span class="pln">domain</span><span class="pun">.</span><span class="pln">handle</span><span class="pun">({</span><span class="pln"> id</span><span class="pun">:</span><span class="pln"> </span><span class="str">'msgId'</span><span class="pun">,</span><span class="pln"> command</span><span class="pun">:</span><span class="pln"> </span><span class="str">'createDummy'</span><span class="pun">,</span><span class="pln"> payload</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> id</span><span class="pun">:</span><span class="pln"> </span><span class="str">'23445'</span><span class="pln"> </span><span class="pun">}</span><span class="pln"> </span><span class="pun">},</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// saved in command queue...</span><span class="pln"><br /></span><span class="pun">});</span></code></pre><div class="alert alert-info feature-description"><h6>Important hint:</h6><p>The command must have the properties: id, command and payload.</p><p>If you want to check the aggregate revision, the command object needs to have the head property: head: { revision: 1234 }</p></div></div></div></div></div></div><div class="row-fluid"><div class="span12"><h2>Components</h2><div class="row-fluid"><div class="span4"><h4 class="feature-title">Aggregate</h4></div><div class="span8"><div class="feature"><pre><code><span class="kwd">var</span><span class="pln"> </span><span class="kwd">base</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'cqrs-domain'</span><span class="pun">).</span><span class="pln">aggregateBase</span><span class="pun">;</span><span class="pln"><br />&nbsp;<br /></span><span class="kwd">module</span><span class="pun">.</span><span class="pln">exports </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">base</span><span class="pun">.</span><span class="pln">extend</span><span class="pun">({</span><span class="pln"><br />&nbsp; <br />&nbsp; &nbsp; </span><span class="com">// snapshotThreshold: 20, </span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// or</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="com">// snapshotThreshold: function() { return 12 + 10; },</span><span class="pln"><br />&nbsp; <br />&nbsp; &nbsp; </span><span class="com">// Commands</span><span class="pln"><br />&nbsp; <br />&nbsp; &nbsp; createDummy</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">apply</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">toEvent</span><span class="pun">(</span><span class="str">'dummyCreated'</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">));</span><span class="pln"><br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">checkBusinessRules</span><span class="pun">(</span><span class="pln">callback</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp;<br />&nbsp; &nbsp; destroyDummy</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> callback</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">apply</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">toEvent</span><span class="pun">(</span><span class="str">'dummyDestroyed'</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">));</span><span class="pln"><br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">checkBusinessRules</span><span class="pun">(</span><span class="pln">callback</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp;<br />&nbsp;<br />&nbsp; &nbsp; </span><span class="com">// Events</span><span class="pln"><br />&nbsp; <br />&nbsp; &nbsp; dummyCreated</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="kwd">set</span><span class="pun">(</span><span class="pln">data</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp;<br />&nbsp; &nbsp; dummyDestroyed</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="kwd">set</span><span class="pun">(</span><span class="str">'destroyed'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp;<br /></span><span class="pun">});</span></code></pre><div class="alert alert-info feature-description"><h6>Important hint:</h6><p>Save the aggregate in the aggregates folder and name it well. In this example dummyAggregate.js</p><p>In a command function create an event and apply it, when applied optionally you can check the business rules.</p><p>In an event function simply save the event data as you like.</p></div></div></div></div><div class="row-fluid"><div class="span4"><h4 class="feature-title">Business rules</h4></div><div class="span8"><div class="feature"><pre><code>module.exports = {
    dummyAggregate: [
 
        function myRule1(changed, previous, events, callback) {
            if (changed.a < previous.a) {
                callback('a must be bigger than a before!');
            } else {
                callback(null);
            }
        }
 
    ]
};</code></pre><div class="alert alert-info feature-description"><h6>Important hint:</h6><p>Save the business rules in the business rules folder.</p></div></div></div></div><div class="row-fluid"><div class="span4"><h4 class="feature-title">Command handler</h4></div><div class="span8"><div class="feature"><pre><code><span class="kwd">var</span><span class="pln"> commandHandlerBase </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">require</span><span class="pun">(</span><span class="str">'cqrs-domain'</span><span class="pun">).</span><span class="pln">commandHandlerBase</span><span class="pun">;</span><span class="pln"><br />&nbsp;<br /></span><span class="kwd">module</span><span class="pun">.</span><span class="pln">exports </span><span class="pun">=</span><span class="pln"> commandHandlerBase</span><span class="pun">.</span><span class="pln">extend</span><span class="pun">({</span><span class="pln"><br />&nbsp;<br />&nbsp; &nbsp; aggregate</span><span class="pun">:</span><span class="pln"> </span><span class="str">'dummyAggregate'</span><span class="pun">,</span><span class="pln"><br />&nbsp;<br />&nbsp; &nbsp; commands</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="str">'createDummy'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'destroyDummy'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'fooIt'</span><span class="pln"> </span><span class="pun">],</span><span class="pln"><br /></span><span class="pun">|</span><span class="pln"><br />&nbsp; &nbsp; fooIt</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> cmd</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">var</span><span class="pln"> </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="typ">Command</span><span class="pun">({</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; command</span><span class="pun">:</span><span class="pln"> </span><span class="str">'createFoo'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; payload</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name</span><span class="pun">:</span><span class="pln"> </span><span class="str">'bla'</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">})).</span><span class="pln">emit</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">evt</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmd</span><span class="pun">.</span><span class="pln">payload</span><span class="pun">.</span><span class="pln">fooId </span><span class="pun">=</span><span class="pln"> evt</span><span class="pun">.</span><span class="pln">payload</span><span class="pun">.</span><span class="pln">id</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">defaultHandle</span><span class="pun">(</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> cmd</span><span class="pun">);</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br />&nbsp;<br /></span><span class="pun">});</span></code></pre><div class="alert alert-info feature-description"><h6>Important hint:</h6><p>Save the command handler in the command handlers folder and name it well. In this example dummyCommandHandler.js</p><p>If you define own handler functions you can do special things like emitting an other command.</p></div></div></div></div></div></div><div class="row-fluid"><div class="span12"><h2>Settings for a scalable solution</h2><div class="row-fluid"><div class="span4"><h4 class="feature-title">Settings</h4></div><div class="span8"><div class="feature"><pre><code><span class="pun">{</span><span class="pln"><br />&nbsp; commandHandlersPath</span><span class="pun">:</span><span class="pln"> __dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/commandHandlers'</span><span class="pun">,</span><span class="pln"><br />&nbsp; aggregatesPath</span><span class="pun">:</span><span class="pln"> __dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/aggregates'</span><span class="pun">,</span><span class="pln"><br />&nbsp; sagaHandlersPath</span><span class="pun">:</span><span class="pln"> __dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/sagaHandlers'</span><span class="pun">,</span><span class="pln"><br />&nbsp; sagasPath</span><span class="pun">:</span><span class="pln"> __dirname </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/sagas'</span><span class="pun">,</span><span class="pln"><br />&nbsp; handleUndispatchedEvents</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span><span class="pln"><br />&nbsp; disableQueuing</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span><span class="pln"><br />&nbsp; forcedQueuing</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span><span class="pln"><br />&nbsp; commandQueue</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'inMemory'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; collectionName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'commands'</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; repository</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'mongodb'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; dbName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'domain'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; collectionName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'sagas'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; host</span><span class="pun">:</span><span class="pln"> </span><span class="str">'localhost'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; port</span><span class="pun">:</span><span class="pln"> </span><span class="lit">27017</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; username</span><span class="pun">:</span><span class="pln"> </span><span class="str">'user'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; password</span><span class="pun">:</span><span class="pln"> </span><span class="str">'pwd'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; timeout</span><span class="pun">:</span><span class="pln"> </span><span class="lit">60</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1000</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; eventStore</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'mongodb'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; dbName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'domain'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; eventsCollectionName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'events'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; snapshotsCollectionName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'snapshots'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; host</span><span class="pun">:</span><span class="pln"> </span><span class="str">'localhost'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; port</span><span class="pun">:</span><span class="pln"> </span><span class="lit">27017</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; username</span><span class="pun">:</span><span class="pln"> </span><span class="str">'user'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; password</span><span class="pun">:</span><span class="pln"> </span><span class="str">'pwd'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; timeout</span><span class="pun">:</span><span class="pln"> </span><span class="lit">60</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1000</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; commandLock</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'mongodb'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; dbName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'domain'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; collectionName</span><span class="pun">:</span><span class="pln"> </span><span class="str">'commandlock'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; host</span><span class="pun">:</span><span class="pln"> </span><span class="str">'localhost'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; port</span><span class="pun">:</span><span class="pln"> </span><span class="lit">27017</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; username</span><span class="pun">:</span><span class="pln"> </span><span class="str">'user'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; password</span><span class="pun">:</span><span class="pln"> </span><span class="str">'pwd'</span><span class="pun">,</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; timeout</span><span class="pun">:</span><span class="pln"> </span><span class="lit">60</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1000</span><span class="pln"><br />&nbsp; </span><span class="pun">},</span><span class="pln"><br />&nbsp; retryOnConcurrencyTimeout</span><span class="pun">:</span><span class="pln"> </span><span class="lit">800</span><span class="pln"><br /></span><span class="pun">}</span></code></pre></div></div></div></div></div></div></div></div></div></div><div class="extra"><div class="extra-inner"><div class="container"><div class="row"><div class="span4"><h4>about me</h4><ul><li><a href="https://github.com/adrai"><i class="icon-github"></i> github</a></li><li><a href="https://twitter.com/adrirai"><i class="icon-twitter"></i> twitter</a></li></ul></div><div class="span4"><h4>help</h4><ul><li><a href="https://github.com/adrai/cqrs/issues"> 
issues (<i class="icon-github"></i>)</a></li></ul></div><div class="span4"><h4>legal</h4><ul><li><a href="https://github.com/adrai/node-cqrs-domain/blob/master/licence">license</a></li></ul></div></div></div></div></div><footer class="footer"><div class="footer-inner"><div class="container"><div class="row"><div class="span12">the cqrs modules and libraries are freely distributable under the terms of the MIT license.</div></div></div></div></footer></body></html>